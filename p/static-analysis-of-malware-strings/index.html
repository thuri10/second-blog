<!DOCTYPE html>
<html lang="en-us">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content='Strings challenges contains an un-encrypted flag stored within the executable. When run, the program will output an MD5 hash of the flag but not the original. Can you extract the flag?'><title>Static Analysis of Malware Strings</title>

<link rel='canonical' href='https://thuri10.github.io/p/static-analysis-of-malware-strings/'>

<link rel="stylesheet" href="/scss/style.min.1b3ac667198cb83edcc9c45e606a6f4dd6910b8ada6b74d7fd988f1b2dfd0c7c.css"><meta property='og:title' content='Static Analysis of Malware Strings'>
<meta property='og:description' content='Strings challenges contains an un-encrypted flag stored within the executable. When run, the program will output an MD5 hash of the flag but not the original. Can you extract the flag?'>
<meta property='og:url' content='https://thuri10.github.io/p/static-analysis-of-malware-strings/'>
<meta property='og:site_name' content='Solar Bits'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='reverse' /><meta property='article:tag' content='malware' /><meta property='article:published_time' content='2021-12-07T19:02:13&#43;03:00'/><meta property='article:modified_time' content='2021-12-07T19:02:13&#43;03:00'/><meta property='og:image' content='https://thuri10.github.io/post/mal/strings.jpg' />
<meta name="twitter:title" content="Static Analysis of Malware Strings">
<meta name="twitter:description" content="Strings challenges contains an un-encrypted flag stored within the executable. When run, the program will output an MD5 hash of the flag but not the original. Can you extract the flag?"><meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content='https://thuri10.github.io/post/mal/strings.jpg' />
    </head>
    <body class="
    article-page has-toc
">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex 
    
        extended
    
">
    
        <div id="article-toolbar">
            <a href="/" class="back-home">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="15 6 9 12 15 18" />
</svg>



                <span>Back</span>
            </a>
        </div>
    
<main class="main full-width">
    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="/p/static-analysis-of-malware-strings/">
                
                    <img src="/post/mal/strings.jpg" loading="lazy" alt="Featured image of post Static Analysis of Malware Strings" />
                
            </a>
        </div>
    

    <div class="article-details">
    

    <h2 class="article-title">
        <a href="/p/static-analysis-of-malware-strings/">Static Analysis of Malware Strings</a>
    </h2>

    
    <h3 class="article-subtitle">
        Strings challenges contains an un-encrypted flag stored within the executable. When run, the program will output an MD5 hash of the flag but not the original. Can you extract the flag?
    </h3>
    

    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Dec 07, 2021</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    6 minute read
                </time>
            </div>
        
    </footer>
    
</div>
</header>

    <section class="article-content">
    
    
    <p>This post is a brief walkthrough of <strong>&ldquo;strings&rdquo;</strong> challenges provided by MalwareTech. The challenges can be downloaded from the following website <a class="link" href="https://www.malwaretech.com/challenges/windows-reversing"  target="_blank" rel="noopener"
    >challenges</a>.</p>
<p>The goal of &ldquo;strings&rdquo; challenges is to understand various implementation of strings in malware through static analysis. Strings are very useful in storing the configurations, decryption keys, data and c&amp;c server addresses.</p>
<p>For analysis, I will use IDApro free for analysis. The author of the challenges provides a set of rules to follow while solving the challenges</p>
<p><strong>Rules &amp; Information</strong></p>
<pre><code>- You are not require to run strings1.exe, this challenge is static analysis only.
- Do not use a debugger or dumper to retrieve the decrypted flag from memory, this is cheating.
- Analysis can be done using the free version of IDA Pro (you donâ€™t need the debugger).
</code></pre>
<h2 id="challenge1--strings1">challenge1- Strings1</h2>
<p><strong>Description</strong></p>
<blockquote>
<p>strings1.exe contains an un-encrypted flag stored within the executable. When run, the program will output an MD5 hash of the flag but not the original. Can you extract the flag?</p>
</blockquote>
<p>Knowing the binary is a windows PE, we drag the binary into IDA for analysis. The analysis of the binary is fast because the binary relative small. The disassembled code is as the one shown in the image below.</p>
<p><figure 
	>
	<a href="/post/mal/strings1.png" >
		<img src="/post/mal/strings1.png"
			
			
			
			loading="lazy"
			alt="Strings IDA">
	</a>
	
	<figcaption>Strings IDA</figcaption>
	
</figure></p>
<p>From the analysis of the above code, we take flag as our input and print out the md5 of the flag. The  <strong>md5_hash</strong> function is responsible for calculating the MD5 hash of the flag. The MessageBoxA is responsible for displaying the md5hash of the flag in a modal dialog box.</p>
<p>The correct flag is <strong>FLAG{CAN-I-MAKE-IT-ANYMORE-OBVIOUS}</strong></p>
<p>Inputting the above flag in the authors website we get a correct message.</p>
<blockquote>
<p>Correct flag for strings1!</p>
</blockquote>
<h2 id="challenge2--strings2">Challenge2- Strings2</h2>
<blockquote>
<p>strings2.exe contains an un-encrypted flag stored within the executable. When run, the program will output an MD5 hash of the flag but not the original. Can you extract the flag?</p>
</blockquote>
<p>The goal of the second challenge is to understand about stack strings. stack strings is where strings are copied in single bytes, this helps malware avoid detection algorithms of common strings.</p>
<p>Drag the binary into IDA for analysis. The main function of the binary looks like the one shown in the image below.</p>
<p><figure 
	>
	<a href="/post/mal/strings2.png" >
		<img src="/post/mal/strings2.png"
			
			
			
			loading="lazy"
			alt="Strings IDA">
	</a>
	
	<figcaption>Strings IDA</figcaption>
	
</figure></p>
<p>From above disassembled code, the flag string is pushed in single bytes, and then passed to the md5_char function. m5_char function is responsible for calculating the MD5sum of the flag as previous seen in <strong>challenge1</strong>.</p>
<p>The flag of the second challenge is  <strong>FLAG{STACK-STRINGS-ARE-BEST-STRINGS}</strong></p>
<h2 id="challenge3---strings3">Challenge3 - Strings3</h2>
<blockquote>
<p>strings3.exe contains an un-encrypted flag stored within the executable. When run, the program will output an MD5 hash of the flag but not the original. Can you extract the flag?</p>
</blockquote>
<p>The goal of the third challenge is to understand how malware uses resources section of the PE. Drag the strings3 binary into IDA and disassemble the main function. The disassembled code looks the one in the image below.</p>
<p><figure 
	>
	<a href="/post/mal/resourcestrings3.png" >
		<img src="/post/mal/resourcestrings3.png"
			
			
			
			loading="lazy"
			alt="Strings IDA">
	</a>
	
	<figcaption>Strings IDA</figcaption>
	
</figure></p>
<p>Looking at the above function is we have a new function, <strong>FindResourceA</strong>. Looking at the windows documentation, FindResourceA function is responsible determination of a resource with the specified type and name in the specified module as shown in the code snip below.</p>
<div class="highlight"><pre tabindex="0" style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++">HRSRC <span style="color:#06b6ef">FindResourceA</span>(
  [in, optional] HMODULE hModule,
  [in]           LPCSTR  lpName,
  [in]           LPCSTR  lpType
);
</code></pre></div><p>From the disassembly above, the name of the resource we are referencing is <strong>rc.rc</strong>. After the execution of FindResourceA function it returns an handle to the specified resource`s information block. In x86 assembly code the return values of functions are put in <strong>eax</strong> register.</p>
<p>From the above code we can reconstruct the c-style code of the FindResource function.</p>
<div class="highlight"><pre tabindex="0" style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">FindResourceA(<span style="color:#f99b15">0</span>, <span style="color:#48b685">&#34;rc.rc&#34;</span>, <span style="color:#f99b15">6</span>)
</code></pre></div><p>The handle module is 0 which is then stored in eax register and then used for calculation of the UID of the resource as shown in assembly below.</p>
<div class="highlight"><pre tabindex="0" style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-nasm" data-lang="nasm"><span style="color:#06b6ef">mov</span> [ebp<span style="color:#5bc4bf">+</span><span style="color:#ef6155">var_8</span>], eax
<span style="color:#06b6ef">mov</span> eax, <span style="color:#f99b15">1</span>
<span style="color:#06b6ef">shl</span> eax, <span style="color:#f99b15">8</span>
<span style="color:#06b6ef">xor</span> edx, edx
<span style="color:#06b6ef">inc</span> edx
<span style="color:#06b6ef">shl</span> edx, <span style="color:#f99b15">4</span>
<span style="color:#06b6ef">or</span> eax, edx
</code></pre></div><p>From the above assembly code, the value of eax is 0. The first line saves eax value to a memory register.</p>
<p>Second line increments the value of eax register by 1. Therefore the new value of eax register is eax=1.</p>
<p>Third line, shifts the bits value of eax register to the left by 8 times. we calculate the new value using python.</p>
<div class="highlight"><pre tabindex="0" style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python3" data-lang="python3"><span style="color:#5bc4bf">&gt;&gt;&gt;</span> <span style="color:#f99b15">1</span> <span style="color:#5bc4bf">&lt;&lt;</span><span style="color:#f99b15">8</span>
<span style="color:#f99b15">256</span>
<span style="color:#5bc4bf">&gt;&gt;&gt;</span> 
</code></pre></div><p>value of 1 shifted to the left 8 times becomes 256 as shown above.</p>
<p>Fourth line, is we are clearing the edx register through xor operation. Therefore the value of edx is 0.</p>
<p>Line 5 we increment the value of edx by 1. The new value stored in edx register is 1, <strong>edx=1</strong> .</p>
<p>Line 6 we shift the value of edx register by 4 positions to the left.</p>
<div class="highlight"><pre tabindex="0" style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python3" data-lang="python3"><span style="color:#5bc4bf">&gt;&gt;&gt;</span> <span style="color:#f99b15">1</span> <span style="color:#5bc4bf">&lt;&lt;</span><span style="color:#f99b15">4</span>
<span style="color:#f99b15">16</span>
<span style="color:#5bc4bf">&gt;&gt;&gt;</span> 
</code></pre></div><p>From the calculation above, the new value od edx register is 16. <strong>edx=16</strong>. Therefore for the last line we are doing a bitwise inclusive <strong>OR</strong> operation of value at eax and edx register.</p>
<p>The values for eax and edx registers are 256 and 16 respectively.</p>
<div class="highlight"><pre tabindex="0" style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python3" data-lang="python3"><span style="color:#5bc4bf">&gt;&gt;&gt;</span> <span style="color:#f99b15">256</span> <span style="color:#5bc4bf">|</span> <span style="color:#f99b15">16</span>
<span style="color:#f99b15">272</span>
<span style="color:#5bc4bf">&gt;&gt;&gt;</span> 
</code></pre></div><p>The result of the bits operation are therefore stored on the eax register. The new <strong>eax</strong> value is 272. Finally the value of eax register is the stored in memory address referenced  below by <strong>UID</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-nasm" data-lang="nasm"><span style="color:#06b6ef">mov</span> [ebp<span style="color:#5bc4bf">+</span><span style="color:#ef6155">UID</span>], eax
</code></pre></div><p><figure 
	>
	<a href="/post/mal/strings3.png" >
		<img src="/post/mal/strings3.png"
			
			
			
			loading="lazy"
			alt="Strings IDA">
	</a>
	
	<figcaption>Strings IDA</figcaption>
	
</figure></p>
<p>The analysis of the disassembled code above, shows the binary loads a resource from the executable referenced by <strong>uID</strong>. The function structure for the LoadStringA functions looks like the one below.</p>
<div class="highlight"><pre tabindex="0" style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#fec418">int</span> <span style="color:#06b6ef">LoadStringA</span>(
  [in, optional] HINSTANCE hInstance,
  [in]           UINT      uID,
  [out]          LPSTR     lpBuffer,
  [in]           <span style="color:#fec418">int</span>       cchBufferMax
);
</code></pre></div><p>The <strong>uID</strong> integer value of the resource to be loaded is 272. For viewing the  executable resources you can use the <strong>ResourcesEditor</strong> tool or python3 <strong>pefile</strong> library as shown in the code below.</p>
<div class="highlight"><pre tabindex="0" style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python3" data-lang="python3"><span style="color:#5bc4bf">import</span> <span style="color:#fec418">pefile</span>
pe <span style="color:#5bc4bf">=</span> pefile<span style="color:#5bc4bf">.</span>PE(<span style="color:#48b685">&#34;./strings3.exe_&#34;</span>)<span style="color:#5bc4bf">***</span>
pe<span style="color:#5bc4bf">.</span>print_info()
</code></pre></div><p>The above 2 line of python3 code print all the information about the executable. As shown below is our resources section and references the string uid we are loading.</p>
<p><figure 
	>
	<a href="/post/mal/string3rc.png" >
		<img src="/post/mal/string3rc.png"
			
			
			
			loading="lazy"
			alt="PE Resources">
	</a>
	
	<figcaption>PE Resources</figcaption>
	
</figure></p>
<p>From the image above, we are loading  <strong>FLAG{RESOURCES-ARE-POPULAR-FOR-MALWARE}</strong> string to our buffer through <strong>LoadStringA</strong> function which is referenced by uid 272. The pointer to the string is then passed to md5 function which is then used for calculating the md5 value of the string and then displayed in the modal box.</p>
<p>The correct flag of the challenge is <strong>FLAG{RESOURCES-ARE-POPULAR-FOR-MALWARE}</strong>.</p>
<p>For learning more about resource section of Portable Executable, check <a class="link" href="https://www.youtube.com/watch?v=3PcgwKffytI"  target="_blank" rel="noopener"
    >PE resources</a> by  <a class="link" href="https://twitter.com/struppigel"  target="_blank" rel="noopener"
    >@struppigel</a> .</p>

</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/reverse/">reverse</a>
        
            <a href="/tags/malware/">malware</a>
        
    </section>


    </footer>


    
</article>

    

    <aside class="related-contents--wrapper">
    
    
        <h2 class="section-title">Related contents</h2>
        <div class="related-contents">
            <div class="flex article-list--tile">
                
                    
<article class="has-image">
    <a href="/p/reversing-malwaretech-8-bit-bytecode-virtual-machine/">
        
        
            <div class="article-image">
                
                    <img src="/post/mal/vm.jpg" loading="lazy" data-key="" data-hash="/post/mal/vm.jpg"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Reversing MalwareTech 8-bit Bytecode Virtual Machine</h2>
        </div>
    </a>
</article>
                
            </div>
        </div>
    
</aside>

     
    
        
    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2020 - 
        
        2022 Solar Bits
    </section>
    
    <section class="powerby">
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        Theme <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.7.0">Stack</a></b> designed by <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a>
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css"integrity="sha256-c0uckgykQ9v5k&#43;IqViZOZKc47Jn7KQil4/MP3ySA3F8="crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css"integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE="crossorigin="anonymous"
            >

            </main>
    
        <aside class="sidebar right-sidebar sticky">
            <section class="widget archives">
                <div class="widget-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



                </div>
                <h2 class="widget-title section-title">Table of contents</h2>
                
                <div class="widget--toc">
                    <nav id="TableOfContents">
  <ol>
    <li><a href="#challenge1--strings1">challenge1- Strings1</a></li>
    <li><a href="#challenge2--strings2">Challenge2- Strings2</a></li>
    <li><a href="#challenge3---strings3">Challenge3 - Strings3</a></li>
  </ol>
</nav>
                </div>
            </section>
        </aside>
    

        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js"integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
